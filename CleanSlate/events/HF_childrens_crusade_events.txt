# Written by Flavio

namespace = HF

#############################################

# Fired on decade pulse after Crusades have been unlocked. Only happens once.
# Only for vanilla, no Random World

#############################################

# Important targets to save:
# The Child											childrens_crusade_leader
# The Child's Sponsor (only 1, never picked by AI)	childrens_crusade_sponsor

# children_crusade_forces//children_crusade_heavy_troops: variable checking how big the army will be when the war is declared (1 point = 5.000 troops// 1 point = 1.000 heavy)
# children_crusade_morale: variable checking how good or bad the morale modifier of the kids will be on start of the crusade
# children_crusade_progress: variable checking progress on the children's trip to the holy land

# Move Crusade from region to region, send events to rulers within that region.
# Possible starting regions:
# world_europe_west_iberia
# world_europe_west_francia
# world_europe_west_germania
# world_europe_west_brittania
# world_europe_north
# world_europe_south_italy
# world_europe_east

# Once Crusade starts moving, the path is the following, unless already closer:
# world_europe_south_italy --> world_europe_south_east (Croatia/Greece) --> world_asia_minor --> WAR BEGINS

#############################################

# Child receives prophetic vision
narrative_event = {
	id = HF.25800
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25800
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes # on_yearly_childhood_pulse

	religion = catholic
	has_global_flag = christian_crusades_unlocked
	min_age = 8
	max_age = 16
	only_capable = yes

	trigger = {
		is_ruler = no
		is_married = no
		is_betrothed = no
		is_alternate_start = no
		NOT = { has_global_flag = childrens_crusade_happened }
		is_inaccessible_trigger = no
		is_devil_worshiper_trigger = no

		NOR = {
			trait = baptized_by_satan
			trait = possessed
			trait = lunatic
			trait = maimed
			trait = mangled
			trait = infirm
			trait = depressed
			trait = stressed
			trait = severely_injured
			trait = eunuch
			trait = blinded
		}

		has_game_rule = {
			name = childrens_crusade
			value = on
		}

		total_years_played >= 50 # Do not let it start immediately after game start, so as to make it less likely to fire together with an official Crusade.

		trigger_if = {
			limit = { is_female = yes }

			top_liege = { has_law = status_of_women_4 }
		}

		top_liege = {
			religion = catholic
			is_nomadic = no
		}

		liege = {
			higher_real_tier_than = COUNT # Scoping issues when locating starting point
			is_landed = yes

			capital_scope = {
				region = world_europe
				NOT = { region = world_europe_south_east } # Make the travel longer by not letting it start in Greece already.
			}
		}

		k_jerusalem = {
			trigger_if = {
				limit = { has_holder = yes }

				holder_scope = {
					NOT = { religion_group = christian }
				}
			}
		}

		c_jerusalem = {
			holder_scope = {
				NOT = { religion_group = christian }
				is_crusade_target = no
			}
		}

		# No crusade is already being prepared or has already started against Jerusalem.
		religion_head = {
			is_preparing_crusade = no

			NOT = {
				any_war = {
					attacker = { character = PREVPREV }

					OR = {
						using_cb = crusade
						using_cb = new_crusade
					}
				}
			}
		}
	}

	weight_multiplier = {
		factor = 1

		mult_modifier = {
			factor = 0.01
			total_years_played < 40
		}

		mult_modifier = {
			factor = 2
			trait = brave
		}

		mult_modifier = {
			factor = 2
			trait = diligent
		}

		mult_modifier = {
			factor = 2
			trait = idolizer
		}

		mult_modifier = {
			factor = 2
			trait = rowdy
		}

		mult_modifier = {
			factor = 2
			trait = zealous
		}

		mult_modifier = {
			factor = 2
			trait = shrewd
		}

		mult_modifier = {
			factor = 2
			trait = quick
		}

		mult_modifier = {
			factor = 4
			trait = genius
		}

		mult_modifier = {
			factor = 2
			trait = attractive
		}

		mult_modifier = {
			factor = 2
			trait = brawny
		}

		mult_modifier = {
			factor = 0.25
			trait = frail
		}

		mult_modifier = {
			factor = 0.5
			trait = sturdy
		}

		mult_modifier = {
			factor = 0.25
			is_female = yes
		}

		mult_modifier = {
			factor = 0.3
			trait = dull
		}

		mult_modifier = {
			factor = 0.2
			trait = slow
		}

		mult_modifier = {
			factor = 0.1
			trait = imbecile
		}

		mult_modifier = {
			factor = 0.5
			trait = ugly
		}

		mult_modifier = {
			factor = 0.02
			trait = inbred
		}

		mult_modifier = {
			factor = 2
			trait = baptized_by_bishop
		}

		mult_modifier = {
			factor = 3
			trait = baptized_by_pope
		}

		mult_modifier = {
			factor = 2
			father_even_if_dead = { lower_real_tier_than = COUNT } # Was historically from a peasant's child
		}

		mult_modifier = {
			factor = 2
			mother_even_if_dead = { lower_real_tier_than = COUNT }
		}

		mult_modifier = {
			factor = 0.5
			age >= 12
		}

		mult_modifier = {
			factor = 0.2
			age >= 14
		}

		mult_modifier = { # Historically accurate
			factor = 1.5
			culture = french
		}

		mult_modifier = {
			factor = 1.5
			culture = german
		}

		mult_modifier = {
			factor = 1.5
			top_liege = { has_landed_title = k_france }
		}

		mult_modifier = {
			factor = 1.5
			top_liege = { has_landed_title = e_francia }
		}

		mult_modifier = {
			factor = 1.5
			top_liege = { has_landed_title = k_germany }
		}

		mult_modifier = {
			factor = 1.5
			top_liege = { has_landed_title = e_hre }
		}

		mult_modifier = {
			factor = 0.25
			year < 900
		}

		mult_modifier = {
			factor = 0.35

			year >= 900
			year < 1000
		}

		mult_modifier = {
			factor = 0.75

			year >= 900
			year < 1200
			total_years_played >= 40 # Prevent race between Pope and Children from being too frequent immediately after start...
		}

		mult_modifier = {
			factor = 2

			year >= 1200
			year <  1300
			total_years_played >= 40
		}

		mult_modifier = {
			factor = 0.75
			year >= 1300
		}

		mult_modifier = {
			factor = 1.5
			liege = { ai = no }
		}
	}

	immediate = {
		set_global_flag = childrens_crusade_happened
		health = 2.0 # Reduce chances of the child dying before the Crusade reaches destination.
		remove_disease_trait_effect = yes # Jesus heals you.

		add_character_modifier = {
			name = voice_of_jesus
			duration = -1
		}

		# Check starting position to determine traveling path.
		if = {
			limit = {
				capital_scope = {
					NOR = {
						region = world_europe_south_italy
						region = world_europe_south_east
						region = world_asia_minor
					}
				}
			}

			clr_character_flag = flag_children_at_achaia
			clr_character_flag = flag_children_at_nikaea
			clr_character_flag = flag_children_at_antioch
			clr_character_flag = flag_children_at_genoa
			set_character_flag = flag_children_at_beginning
		}
		else_if = {
			limit = {
				capital_scope = { region = world_europe_south_italy }
			}

			clr_character_flag = flag_children_at_genoa
			clr_character_flag = flag_children_at_nikaea
			clr_character_flag = flag_children_at_antioch
			set_character_flag = flag_children_at_achaia
		}
		else_if = {
			limit = {
				capital_scope = { region = world_europe_south_east }
			}

			clr_character_flag = flag_children_at_genoa
			clr_character_flag = flag_children_at_achaia
			clr_character_flag = flag_children_at_antioch
			set_character_flag = flag_children_at_nikaea
		}
		else_if = {
			limit = {
				capital_scope = { region = world_asia_minor }
			}

			clr_character_flag = flag_children_at_genoa
			clr_character_flag = flag_children_at_achaia
			clr_character_flag = flag_children_at_nikaea
			set_character_flag = flag_children_at_antioch
		}

		if = { # Safety check
			limit = {
				NOR = {
					has_character_flag = flag_children_at_beginning
					has_character_flag = flag_children_at_genoa
					has_character_flag = flag_children_at_achaia
					has_character_flag = flag_children_at_nikaea
					has_character_flag = flag_children_at_antioch
				}
			}

			set_character_flag = flag_children_at_genoa
		}
	}

	option = {
		name = EVTOPTAHF25800

		piety = 150

		if = {
			limit = {
				liege = { lower_real_tier_than = COUNT }
			}
			liege = { liege = { ROOT = { move_character = PREV } } } # Courtiers of Barons can cause location issues.
		}

		if = {
			limit = {
				age < 12
				NOT = { has_focus = focus_ch_struggle }
			}

			set_focus = focus_ch_struggle
		}
		else_if = {
			limit = {
				age >= 12
				is_adult = no
				NOT = { has_focus = focus_ed_martial }
			}

			set_focus = focus_ed_martial
		}
		else_if = {
			limit = {
				is_adult = yes
				NOT = { has_focus = focus_war }
			}

			set_focus = focus_war
		}

		save_global_event_target_as = childrens_crusade_leader
		set_character_flag = special_marshal # Always allow to be in command

		liege = {
			narrative_event = { id = HF.25806 }

			primary_title = {
				create_title = {
					tier = DUKE
					name = CHILDRENS_CRUSADE_TEMPORARY
					landless = yes
					temporary = yes
					adventurer = yes
					custom_created = yes
					short_name = yes
					culture = ROOT
					holder = ROOT
					base_title = THIS
					# mercenary = yes
					ruler = CHILD_CRUSADER
					ruler_female = CHILD_CRUSADER_FEM
					foa = CHILD_CRUSADER_FOA
				}
			}

			ROOT = {
				set_defacto_liege = THIS
				diplomatic_immunity = yes
			}
		}

		set_character_flag = ai_flag_refuse_conversion
		set_character_flag = flag_childrens_crusade_leader # Used for on_death events
		add_trait = disinherited # Prevent Crusade from being broken by unlucky death of parent

		narrative_event = {
			id = HF.25808 # Main hidden tombola
			days = 100
			random = 100
		}
	}
}

# on_death: Child died
character_event = {
	id = HF.25801

	is_triggered_only = yes
	hide_window = yes

	has_character_flag = flag_childrens_crusade_leader

	immediate = {
		any_courtier = {
			limit = {
				is_ruler = no
				is_landed = no
			}

			death = { death_reason = death_missing }
		}

		activate_title = {
			title = primary_title
			status = no
		}

		destroy_landed_title = primary_title

		any_player = {
			limit = {
				OR = {
					religion = catholic
					is_foe = ROOT
				}
			}

			narrative_event = {
				id = HF.25802 # Notification
				days = 15
			}
		}
	}
}

# Players informed of death of leader of the children's crusade
narrative_event = {
	id = HF.25802
	title = EVTTITLEHF25802
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion

	desc = {
		text = EVTDESCAHF25802
		trigger = {
			FROM = {
				killer = { character = ROOT }
			}
		}
	}
	desc = {
		text = EVTDESCBHF25802
		trigger = {
			is_close_relative = FROM
			NOT = { FROM = { killer = { character = ROOT } } }
		}
	}
	desc = {
		text = EVTDESCCHF25802
		trigger = {
			NOR = {
				is_close_relative = FROM
				FROM = { killer = { character = ROOT } }
			}
		}
	}

	is_triggered_only = yes
	hide_new = yes

	option = {
		name = EVTOPTAHF25802
	}
}

# on_become_imprisoned_any_reason: Child was imprisoned
character_event = {
	id = HF.25803

	is_triggered_only = yes
	hide_window = yes

	has_character_flag = flag_childrens_crusade_leader

	immediate = {
		diplomatic_immunity = no

		any_courtier = {
			limit = {
				is_ruler = no
				is_landed = no
				host = { character = ROOT }
			}

			death = { death_reason = death_missing }
		}

		activate_title = {
			title = primary_title
			status = no
		}

		destroy_landed_title = primary_title

		FROM = {
			narrative_event = {
				id = HF.25804 # Jailer informed and effects applied
				days = 12
			}
		}

		any_player = {
			limit = {
				religion = catholic
				NOT = { character = FROM }
			}

			narrative_event = {
				id = HF.25805 # Notification
				days = 12
			}
		}
	}
}

# Jailer informed that he stopped the Childrens' Crusade
narrative_event = {
	id = HF.25804
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25804
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes

	trigger = {
		FROM = { is_alive = yes }
	}

	option = {
		name = EVTOPTAHF25804
	}
}

# People informed that somebody captured the child leader
narrative_event = {
	id = HF.25805
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25805
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes

	option = {
		name = EVTOPTAHF25805
	}
}

# Liege of child receives first event
narrative_event = {
	id = HF.25806
	title = EVTTITLEHF25806
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	desc = {
		text = EVTDESCAHF25806
		trigger = { is_close_relative = FROM }
	}
	desc = {
		text = EVTDESCBHF25806
		trigger = {
			NOT = { is_close_relative = FROM }
		}
	}

	is_triggered_only = yes
	hide_new = yes

	immediate = {
		set_character_flag = flag_visited_by_childrens_crusade # Prevents to be targeted by event again
	}

	option = { # Support child as sponsor
		name = EVTOPTAHF25806

		trigger = {
			NOR = {
				trait = cynical
				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}
		}

		custom_tooltip = { text = TT_EVTOPTAHF25806 }

		add_trait_fully_silently_zealous_effect = yes
		tiered_piety_reward_effect = yes

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_believed_in_me
				who = ROOT
				years = 15
			}

			save_persistent_event_target = {
				name = childrens_crusade_sponsor_per
				scope = ROOT
			}
		}

		ai_chance = { factor = 0 }
	}

	option = { # Support child with troops
		name = EVTOPTBHF25806

		trigger = {
			NOT = {
				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}
		}

		custom_tooltip = { text = TT_EVTOPTBHF25806 }

		random = {
			chance = 25
			add_trait_partially_kind_effect = yes
		}

		FROM = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_heavy_troops
					value = 2
				}
			}
		}

		tiered_piety_reward_effect = yes

		capital_scope = {
			show_scope_change = no

			add_province_modifier = {
				name = kid_crusade_pledged_troops
				months = 40
				stacking = yes
			}
		}

		ai_chance = { factor = 0 }
	}

	option = { # Give some food and send them on their way
		name = EVTOPTCHF25806

		random = {
			chance = 20
			add_trait_partially_kind_effect = yes
		}

		hidden_effect = {
			FROM = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}
			}
		}

		transfer_scaled_wealth = {
			to = event_target:childrens_crusade_leader
			value = 1
			min = 50
			max = 100
		}

		ai_chance = {
			factor = 10

			trigger = { trait = kind }
		}
	}

	option = { # Sell into slavery - Requires ruler to be deceitful and child leader to be trusting
		name = EVTOPTDHF25806
		tooltip_info = deceitful

		trigger = {
			trait = deceitful
			FROM = { trait = trusting }

			NOR = {
				# Sponsor legitimizes children
				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}

				dynasty = FROM
				is_close_relative = FROM
			}
		}

		custom_tooltip = {
			text = TT_EVTOPTDHF25806

			FROM = {
				any_courtier = {
					limit = {
						is_ruler = no
						is_adult = no
					}

					death = { death_reason = death_slavery }
				}

				activate_title = {
					title = primary_title
					status = no
				}

				destroy_landed_title = primary_title
				death = { death_reason = death_slavery }
			}
		}

		tiered_piety_negative_effect = yes

		scaled_wealth = {
			value = 1
			min = 150
			max = 300
		}

		ai_chance = {
			factor = 10

			mult_modifier = {
				factor = 2
				trait = greedy
			}

			mult_modifier = {
				factor = 1.5
				trait = cynical
			}
			mult_modifier = {
				factor = 2
				is_rival = FROM
			}

			mult_modifier = { # Historical triggers
				factor = 2
				is_merchant_republic = yes
			}
		}
	}

	option = { # Set guards on them
		name = {
			text = EVTOPTEHF25806_A
			trigger = { is_close_relative = FROM }
		}
		name = {
			text = EVTOPTEHF25806_B
			trigger = {
				NOT = { is_close_relative = FROM }
			}
		}
		tooltip_info = cruel

		trigger = { trait = cruel }

		hidden_effect = {
			FROM = {
				change_variable = {
					which = children_crusade_morale
					value = -1
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = { # Ignore them
		name = {
			text = EVTOPTFHF25806_A
			trigger = { is_close_relative = FROM }
		}
		name = {
			text = EVTOPTFHF25806_B
			trigger = {
				NOT = { is_close_relative = FROM }
			}
		}

		trigger = {
			NOT = { trait = cruel }
		}

		ai_chance = { factor = 100 }
	}

	after = {
		if = {
			limit = { FROM = { is_alive = yes } } # If you have not killed them already, you monster

			any_player = {
				limit = {
					religion_group = christian

					NOR = {
						character = FROM
						character = ROOT
					}
				}

				narrative_event = {
					id = HF.25807 # General Notification of the Children's Crusade start
					days = 12
				}
			}
		}
	}
}

# All Catholic players get news of the crusade
narrative_event = {
	id = HF.25807
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25807
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	option = {
		name = EVTOPTAHF25807
		tooltip_info = cynical

		trigger = { trait = cynical }
	}

	option = {
		name = EVTOPTBHF25807
		tooltip_info = zealous

		trigger = { trait = zealous }
	}

	option = {
		name = EVTOPTCHF25807

		trigger = {
			NOR = {
				trait = cynical
				trait = zealous
			}
		}
	}
}

# Main umbrella event for the child leader
narrative_event = {
	id = HF.25808

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		# First, handle the child's growth

		# Make sure that he always has the correct Military focus
		if = {
			limit = {
				age < 12
				NOT = { has_focus = focus_ch_struggle }
			}

			set_focus = focus_ch_struggle
		}
		else_if = {
			limit = {
				age >= 12
				is_adult = no
				NOT = { has_focus = focus_ed_martial }
			}

			set_focus = focus_ed_martial
		}
		else_if = {
			limit = {
				is_adult = yes
				NOT = { has_focus = focus_war }
			}

			set_focus = focus_war
		}

		# Make sure he has not lost his faith
		remove_trait_silently_cynical_effect = yes

		if = {
			limit = {
				age >= 14
				NOT = { trait = zealous }
			}

			random = {
				chance = 25
				add_trait = zealous
			}
		}

		if = {
			limit = { NOT = { religion = catholic } }
			religion = catholic
		}

		if = {
			limit = { NOT = { has_character_modifier = voice_of_jesus } }

			add_character_modifier = {
				name = voice_of_jesus
				duration = -1
			}
		}

		remove_disease_trait_effect = yes # Jesus heals you

		# Chance for the child to become a slightly better fighter while traveling
		if = {
			limit = { martial < 18 } # Let's not get crazy...

			random = {
				chance = 10
				change_martial = 1
			}
		}

		if = {
			limit = { combat_rating < 50 } # Let's not get crazy...

			random = {
				chance = 10
				add_one_duel_experience_modifier = yes
			}
		}

		# Historically reported to be naive
		random = {
			chance = 10
			add_trait_fully_trusting_effect = yes
		}

		# Chance of kid being more persuasive and gaining more followers.
		random = {
			chance = 15

			mult_modifier = {
				factor = 1.5
				martial >= 6
			}

			mult_modifier = {
				factor = 1.5
				martial >= 8
			}

			mult_modifier = {
				factor = 1.5
				martial >= 10
			}

			mult_modifier = {
				factor = 1.5
				martial >= 12
			}

			mult_modifier = {
				factor = 1.75
				piety >= 150
			}

			mult_modifier = {
				factor = 1.75
				piety >= 250
			}

			mult_modifier = {
				factor = 1.75
				piety >= 450
			}

			mult_modifier = {
				factor = 1.75
				piety >= 650
			}

			mult_modifier = {
				factor = 1.75
				wealth >= 150
			}

			mult_modifier = {
				factor = 1.75
				wealth >= 350
			}

			mult_modifier = {
				factor = 1.75
				wealth >= 550
			}

			mult_modifier = {
				factor = 1.75
				prestige >= 250
			}

			mult_modifier = {
				factor = 1.75
				prestige >= 500
			}

			mult_modifier = {
				factor = 1.75
				prestige >= 750
			}

			mult_modifier = {
				factor = 1.75
				prestige >= 1000
			}

			mult_modifier = {
				factor = 1.5

				persistent_event_target:childrens_crusade_sponsor_per = {
					is_alive = yes
					real_tier = DUKE
				}
			}

			mult_modifier = {
				factor = 1.75

				persistent_event_target:childrens_crusade_sponsor_per = {
					is_alive = yes
					real_tier = KING
				}
			}

			mult_modifier = {
				factor = 2

				persistent_event_target:childrens_crusade_sponsor_per = {
					is_alive = yes
					real_tier = EMPEROR
				}
			}

			change_variable = {
				which = children_crusade_forces
				value = 2
			}
		}

		# Random chance of commanders joining their cause
		random_list = {
			2 = {
				spawn_fantastic_commander_effect = yes
				clear_event_target = invited_character
			}

			15 = {
				spawn_good_commander_effect = yes
				clear_event_target = invited_character
			}

			80 = {
				mult_modifier = {
					factor = 0.85
					martial >= 6
				}

				mult_modifier = {
					factor = 0.85
					martial >= 8
				}

				mult_modifier = {
					factor = 0.85
					martial >= 10
				}

				mult_modifier = {
					factor = 0.85
					martial >= 12
				}

				mult_modifier = {
					factor = 0.85
					piety >= 150
				}

				mult_modifier = {
					factor = 0.85
					piety >= 250
				}

				mult_modifier = {
					factor = 0.85
					piety >= 450
				}

				mult_modifier = {
					factor = 0.85
					piety >= 650
				}

				mult_modifier = {
					factor = 0.85
					wealth >= 150
				}

				mult_modifier = {
					factor = 0.85
					wealth >= 350
				}

				mult_modifier = {
					factor = 0.85
					wealth >= 550
				}

				mult_modifier = {
					factor = 0.85
					prestige >= 250
				}

				mult_modifier = {
					factor = 0.85
					prestige >= 500
				}

				mult_modifier = {
					factor = 0.85
					prestige >= 750
				}

				mult_modifier = {
					factor = 0.85
					prestige >= 1000
				}

				mult_modifier = {
					factor = 0.85

					persistent_event_target:childrens_crusade_sponsor_per = {
						is_alive = yes
						real_tier = DUKE
					}
				}

				mult_modifier = {
					factor = 0.75

					persistent_event_target:childrens_crusade_sponsor_per = {
						is_alive = yes
						real_tier = KING
					}
				}

				mult_modifier = {
					factor = 0.5

					persistent_event_target:childrens_crusade_sponsor_per = {
						is_alive = yes
						real_tier = EMPEROR
					}
				}
			}
		}

		## Random list flavor for rulers in the area

		# Possible starting regions:
		# world_europe_west_iberia
		# world_europe_west_francia
		# world_europe_west_germania
		# world_europe_west_brittania
		# world_europe_north
		# world_europe_south_italy
		# world_europe_east

		# Regions travelled through:
		# world_europe_south_east
		# world_asia_minor

		# Check for the Crusaders' location and fire random event for a ruler who lives there
		trigger_switch = {
			on_trigger = has_character_flag

			flag_children_at_beginning = {
				random_playable_ruler = {
					limit = {
						religion_group = christian

						capital_scope = {
							OR = {
								region = world_europe_west_iberia
								region = world_europe_west_francia
								region = world_europe_west_germania
								region = world_europe_west_britannia
								region = world_europe_north
								region = world_europe_south_italy
								region = world_europe_east
							}
						}

						NOT = { has_character_flag = flag_visited_by_childrens_crusade }
					}

					preferred_limit = {
						ai = no

						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					preferred_limit = {
						ai = no
					}

					preferred_limit = {
						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					set_character_flag = flag_visited_by_childrens_crusade
					character_event = { id = HF.25809 } # Random list
				}
			}

			flag_children_at_genoa = {
				random_playable_ruler = {
					limit = {
						religion_group = christian
						capital_scope = { region = world_europe_south_italy }
						NOT = { has_character_flag = flag_visited_by_childrens_crusade }
					}

					preferred_limit = {
						ai = no

						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					preferred_limit = {
						ai = no
					}

					preferred_limit = {
						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					set_character_flag = flag_visited_by_childrens_crusade
					character_event = { id = HF.25809 } # Random list
				}
			}

			flag_children_at_achaia = {
				random_playable_ruler = {
					limit = {
						religion_group = christian
						capital_scope = { region = world_europe_south_east }
						NOT = { has_character_flag = flag_visited_by_childrens_crusade }
					}

					preferred_limit = {
						ai = no

						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					preferred_limit = {
						ai = no
					}

					preferred_limit = {
						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					set_character_flag = flag_visited_by_childrens_crusade
					character_event = { id = HF.25809 } # Random list
				}
			}

			flag_children_at_nikaea = {
				random_playable_ruler = {
					limit = {
						religion_group = christian
						capital_scope = { region = world_asia_minor }
						NOT = { has_character_flag = flag_visited_by_childrens_crusade }
					}

					preferred_limit = {
						ai = no

						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					preferred_limit = {
						ai = no
					}

					preferred_limit = {
						any_child = {
							age >= 8
							is_adult = no
							is_ruler = no
							is_primary_heir = no
							host = { character = PREVPREV }
						}
					}

					set_character_flag = flag_visited_by_childrens_crusade
					character_event = { id = HF.25809 } # Random list
				}
			}
		}

		## Check traveling progress.
		# Every 3 pulses, move to the next place
		if = {
			limit = {
				check_variable = {
					which = children_crusade_progress
					value >= 3
				}
			}

			set_variable = {
				which = children_crusade_progress
				value = 0
			}

			move_childrens_crusade_region_effect = yes
		}
		else = {
			change_variable = {
				which = children_crusade_progress
				value = 1
			}

			narrative_event = {
				id = HF.25808 # Fire event again, sending more random flavor to local rulers and increasing progress variable
				days = 50
				random = 70
			}
		}
	}
}

# Second umbrella, firing for random ruler in the region where the kids are at the moment
character_event = {
	id = HF.25809

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		random_list = {
			# Children request food
			# Children request troops
			# Children are upsetting the local priests

			33 = { character_event = { id = HF.25810 } }
			33 = { character_event = { id = HF.25811 } }

			33 = {
				trigger = {
					any_vassal = {
						is_theocracy = yes
						religion = ROOT
					}
				}

				character_event = { id = HF.25812 }
			}
		}

		# After the children come, one of yours will join them
		if = {
			limit = {
				any_child = {
					age >= 8
					is_adult = no
					is_ruler = no
					is_primary_heir = no
					prisoner = no
					host = { character = ROOT }
				}
			}

			random_child = {
				limit = {
					age >= 8
					is_adult = no
					is_ruler = no
					is_primary_heir = no
					prisoner = no
					host = { character = ROOT }
				}

				preferred_limit = {
					OR = {
						trait = zealous
						trait = idolizer
						trait = affectionate
						has_focus = focus_ch_faith
						has_focus = focus_ed_learning
					}
				}

				character_event = {
					id = HF.25813 # The child flees, then inform the parent
					days = 5
				}
			}
		}

		# Or any other close relative, if AI (mainly to increase the court of the Children's Crusade)
		if = {
			limit = {
				ai = yes

				any_close_relative = {
					age >= 8
					is_adult = no
					is_ruler = no
					is_primary_heir = no
					prisoner = no
					host = { character = ROOT }
				}
			}

			random_close_relative = {
				limit = {
					age >= 6
					is_adult = no
					is_ruler = no
					is_primary_heir = no
					prisoner = no
					host = { character = ROOT }
				}

				random = {
					chance = 80

					mult_modifier = {
						factor = 1.25

						OR = {
							trait = gregarious
							trait = zealous
							trait = idolizer
							trait = affectionate
							has_focus = focus_ch_faith
							has_focus = focus_ed_learning
						}
					}

					move_character = FROM
					set_defacto_liege = FROM
					religion = FROM
					set_character_flag = no_court_invites
					add_trait = disinherited
				}
			}
		}

		# Finally, pick automatically any underage unimportant courtier to join the crusade
		if = {
			limit = {
				any_courtier = {
					age >= 6
					is_adult = no
					is_ruler = no
					is_primary_heir = no
					is_betrothed = no
					prisoner = no
					num_of_claims < 1
					host = { character = ROOT }

					NOR = {
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}
			}

			random_courtier = {
				limit = {
					age >= 6
					is_adult = no
					is_ruler = no
					is_betrothed = no
					is_primary_heir = no
					prisoner = no
					num_of_claims < 1
					host = { character = ROOT }

					NOR = {
						dynasty = ROOT
						is_close_relative = ROOT
					}
				}

				random = {
					chance = 90

					mult_modifier = {
						factor = 1.12

						OR = {
							trait = zealous
							trait = idolizer
							trait = affectionate
							has_focus = focus_ch_faith
							has_focus = focus_ed_learning
						}
					}

					move_character = FROM
					set_defacto_liege = FROM
					religion = FROM
					set_character_flag = no_court_invites
					add_trait = disinherited
				}
			}
		}
	}
}

# Random Ruler: The Children want food
character_event = {
	id = HF.25810
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25810
	picture = GFX_evt_childrens_crusade
	border = GFX_event_normal_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	option = { # Support child as sponsor
		name = EVTOPTAHF25810

		trigger = {
			NOR = {
				trait = cynical

				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}
		}

		custom_tooltip = { text = TT_EVTOPTAHF25806 }

		add_trait_fully_silently_zealous_effect = yes
		tiered_piety_reward_effect = yes

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_believed_in_me
				who = ROOT
				years = 15
			}

			save_persistent_event_target = {
				name = childrens_crusade_sponsor_per
				scope = ROOT
			}
		}

		ai_chance = { factor = 0 }
	}

	option = { # Give some food and send them on their way
		name = EVTOPTBHF25810

		random = {
			chance = 20
			add_trait_partially_kind_effect = yes
		}

		hidden_effect = {
			event_target:childrens_crusade_leader = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}
			}
		}

		transfer_scaled_wealth = {
			to = event_target:childrens_crusade_leader
			value = 1
			min = 50
			max = 100
		}

		ai_chance = {
			factor = 10

			trigger = { trait = kind }
		}
	}

	option = { # Sell into slavery - Requires ruler to be deceitful and child leader to be trusting
		name = EVTOPTCHF25810
		tooltip_info = deceitful

		trigger = {
			trait = deceitful

			event_target:childrens_crusade_leader = {
				trait = trusting

				# Sponsor legitimizes children
				NOT = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}

			NOR = {
				dynasty = event_target:childrens_crusade_leader
				is_close_relative = event_target:childrens_crusade_leader
			}
		}

		custom_tooltip = {
			text = TT_EVTOPTDHF25806

			event_target:childrens_crusade_leader = {
				any_courtier = {
					limit = {
						is_ruler = no
						is_adult = no
					}

					death = { death_reason = death_slavery }
				}

				activate_title = {
					title = primary_title
					status = no
				}

				destroy_landed_title = primary_title
				death = { death_reason = death_slavery }
			}
		}

		tiered_piety_negative_effect = yes

		scaled_wealth = {
			value = 1
			min = 150
			max = 300
		}

		ai_chance = {
			factor = 10

			mult_modifier = {
				factor = 2
				trait = greedy
			}

			mult_modifier = {
				factor = 1.5
				trait = cynical
			}

			mult_modifier = {
				factor = 2
				is_rival = event_target:childrens_crusade_leader
			}

			mult_modifier = { # Historical triggers
				factor = 2
				is_merchant_republic = yes
			}
		}
	}

	option = { # Set guards on them
		name = EVTOPTDHF25810
		tooltip_info = cruel

		trigger = { trait = cruel }

		hidden_effect = {
			event_target:childrens_crusade_leader = {
				change_variable = {
					which = children_crusade_morale
					value = -1
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = { # Ignore them
		name = EVTOPTEHF25810

		trigger = { NOT = { trait = cruel } }

		ai_chance = { factor = 100 }
	}
}

# Random Ruler: The Children want troops
character_event = {
	id = HF.25811
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25811
	picture = GFX_evt_childrens_crusade
	border = GFX_event_normal_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	option = { # Support child as sponsor
		name = EVTOPTAHF25811

		trigger = {
			NOR = {
				trait = cynical

				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}
		}

		custom_tooltip = { text = TT_EVTOPTAHF25806 }

		add_trait_fully_silently_zealous_effect = yes
		tiered_piety_reward_effect = yes

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_believed_in_me
				who = ROOT
				years = 15
			}

			save_persistent_event_target = {
				name = childrens_crusade_sponsor_per
				scope = ROOT
			}
		}

		ai_chance = { factor = 0 }
	}

	option = { # Support child with troops
		name = EVTOPTBHF25811

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes } }
			}
		}

		custom_tooltip = { text = TT_EVTOPTBHF25806 }

		random = {
			chance = 25
			add_trait_partially_kind_effect = yes
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_heavy_troops
					value = 2
				}
			}
		}

		tiered_piety_reward_effect = yes

		capital_scope = {
			show_scope_change = no

			add_province_modifier = {
				name = kid_crusade_pledged_troops
				months = 40
				stacking = yes
			}
		}

		ai_chance = { factor = 0 }
	}

	option = { # Allow children to recruit amongst peasants
		name = EVTOPTCHF25811

		random = {
			chance = 20
			add_trait_partially_kind_effect = yes
		}

		hidden_effect = {
			event_target:childrens_crusade_leader = {
				change_variable = {
					which = children_crusade_forces
					value = 2
				}
			}
		}

		capital_scope = {
			show_scope_change = no

			add_province_modifier = {
				name = kid_crusade_recruited_peasants
				months = 40
				stacking = yes
			}
		}

		ai_chance = {
			factor = 10

			trigger = { trait = kind }
		}
	}

	option = { # Sell into slavery - Requires ruler to be deceitful and child leader to be trusting
		name = EVTOPTDHF25811
		tooltip_info = deceitful

		trigger = {
			trait = deceitful

			event_target:childrens_crusade_leader = {
				trait = trusting

				NOT = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes } # Sponsor legitimizes children
				}
			}

			NOR = {
				dynasty = event_target:childrens_crusade_leader
				is_close_relative = event_target:childrens_crusade_leader
			}
		}

		custom_tooltip = {
			text = TT_EVTOPTDHF25806

			event_target:childrens_crusade_leader = {
				any_courtier = {
					limit = {
						is_ruler = no
						is_adult = no
					}

					death = { death_reason = death_slavery }
				}

				activate_title = {
					title = primary_title
					status = no
				}

				destroy_landed_title = primary_title
				death = { death_reason = death_slavery }
			}
		}

		tiered_piety_negative_effect = yes

		scaled_wealth = {
			value = 1
			min = 150
			max = 300
		}

		ai_chance = {
			factor = 10

			mult_modifier = {
				factor = 2
				trait = greedy
			}

			mult_modifier = {
				factor = 1.5
				trait = cynical
			}

			mult_modifier = {
				factor = 2
				is_rival = event_target:childrens_crusade_leader
			}

			mult_modifier = { # Historical triggers
				factor = 2
				is_merchant_republic = yes
			}
		}
	}

	option = { # Set guards on them
		name = EVTOPTEHF25811
		tooltip_info = cruel

		trigger = { trait = cruel }

		hidden_effect = {
			event_target:childrens_crusade_leader = {
				change_variable = {
					which = children_crusade_morale
					value = -1
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = { # Ignore them
		name = EVTOPTFHF25811

		trigger = {
			NOT = { trait = cruel }
		}

		ai_chance = { factor = 100 }
	}
}

# Random Ruler: The Children are upsetting the local clergy
character_event = {
	id = HF.25812
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25812
	picture = GFX_evt_childrens_crusade
	border = GFX_event_normal_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	immediate = {
		random_vassal = {
			limit = {
				is_theocracy = yes
				religion = ROOT
			}

			save_event_target_as = child_outraged_priest
		}
	}

	option = { # Support child as sponsor
		name = EVTOPTAHF25812

		trigger = {
			NOR = {
				trait = cynical

				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes }
				}
			}
		}

		custom_tooltip = { text = TT_EVTOPTAHF25806 }

		add_trait_fully_silently_zealous_effect = yes
		tiered_piety_reward_effect = yes

		event_target:childrens_crusade_leader = {
			show_scope_change = no
			opinion = {
				name = opinion_believed_in_me
				who = ROOT
				years = 15
			}

			save_persistent_event_target = {
				name = childrens_crusade_sponsor_per
				scope = ROOT
			}
		}

		reverse_opinion = {
			name = opinion_outraged
			who = event_target:child_outraged_priest
			years = 15
		}

		ai_chance = { factor = 0 }
	}

	option = { # Sell into slavery - Requires ruler to be deceitful and child leader to be trusting
		name = EVTOPTDHF25812
		tooltip_info = deceitful

		trigger = {
			trait = deceitful

			event_target:childrens_crusade_leader = {
				trait = trusting

				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes } } # Sponsor legitimizes children
			}

			NOR = {
				dynasty = event_target:childrens_crusade_leader
				is_close_relative = event_target:childrens_crusade_leader
			}
		}

		custom_tooltip = {
			text = TT_EVTOPTDHF25806

			event_target:childrens_crusade_leader = {
				any_courtier = {
					limit = {
						is_ruler = no
						is_adult = no
					}

					death = { death_reason = death_slavery }
				}

				activate_title = {
					title = primary_title
					status = no
				}

				destroy_landed_title = primary_title
				death = { death_reason = death_slavery }
			}
		}

		tiered_piety_negative_effect = yes

		scaled_wealth = {
			value = 1
			min = 150
			max = 300
		}

		ai_chance = {
			factor = 10

			mult_modifier = {
				factor = 2
				trait = greedy
			}

			mult_modifier = {
				factor = 1.5
				trait = cynical
			}

			mult_modifier = {
				factor = 2
				is_rival = event_target:childrens_crusade_leader
			}

			mult_modifier = { # Historical triggers
				factor = 2
				is_merchant_republic = yes
			}
		}
	}

	option = { # Set guards on them
		name = EVTOPTEHF25812

		tiered_piety_reward_effect = yes

		reverse_opinion = {
			name = opinion_relieved
			who = event_target:child_outraged_priest
			years = 5
		}

		hidden_effect = {
			event_target:childrens_crusade_leader = {
				change_variable = {
					which = children_crusade_morale
					value = -1
				}
			}
		}

		ai_chance = { factor = 20 }
	}

	option = { # Allow them to keep doing their thing
		name = EVTOPTFHF25812

		reverse_opinion = {
			name = opinion_relieved
			who = event_target:childrens_crusade_leader
			years = 5
		}

		reverse_opinion = {
			name = opinion_outraged
			who = event_target:child_outraged_priest
			years = 5
		}

		ai_chance = { factor = 80 }
	}
}

# Random Ruler's child: The call of Jesus
character_event = {
	id = HF.25813
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25813
	picture = GFX_evt_childrens_crusade
	border = GFX_event_normal_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	trigger = {
		is_ruler = no

		event_target:childrens_crusade_leader = {
			is_alive = yes
			NOT = { persistent_event_target:childrens_crusade_sponsor_per = { is_parent_of = ROOT } }
		}
	}

	option = { # Go with Crusade
		name = EVTOPTAHF25813

		trigger = {
			NOT = { trait = cynical }
		}

		piety = 25
		move_character = FROMFROM
		set_defacto_liege = FROMFROM
		religion = FROMFROM
		set_character_flag = no_court_invites
		add_trait = disinherited
		FROM = { character_event = { id = HF.25814 } } # Notify Parent

		ai_chance = { factor = 100 }
	}

	option = { # No
		name = EVTOPTBHF25813

		ai_chance = {
			factor = 5

			mult_modifier = {
				factor = 2
				trait = timid
			}

			mult_modifier = {
				factor = 2
				trait = craven
			}
		}
	}
}

# Random Ruler: Your child left
character_event = {
	id = HF.25814
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25814
	picture = GFX_evt_childrens_crusade
	border = GFX_event_normal_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes
	hide_new = yes

	option = { # Support crusade to increase chances of survival for child
		name = EVTOPTAHF25814

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { is_alive = yes } }
			}
		}

		custom_tooltip = {
			text = TT_EVTOPTAHF25806

			event_target:childrens_crusade_leader = {
				save_persistent_event_target = {
					name = childrens_crusade_sponsor_per
					scope = ROOT
				}
			}
		}

		tiered_piety_reward_effect = yes

		ai_chance = { factor = 0 }
	}

	option = {
		name = {
			text = EVTOPTAHF25814_A
			trigger = { trait = kind }
		}
		name = {
			text = EVTOPTAHF25814_B
			trigger = {
				NOR = {
					trait = kind
					trait = cruel
				}
			}
		}
		name = {
			text = EVTOPTAHF25814_C
			trigger = { trait = cruel }
		}

		if = {
			limit = { trait = kind }
			add_trait_silently_stressed_effect = yes
		}

		tiered_prestige_negative_effect = yes
	}
}

# Christian players informed that the Crusade has reached Genoa
narrative_event = {
	id = HF.25815
	title = EVTTITLEHF25815
	desc = EVTDESCAHF25815
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_new = yes

	# Sponsor sends troops
	# Sponsor sends reinforcements/ships
	# Sponsor sends money
	# Sponsor does nothing
	# Default

	option = { # Send troops to help/protect
		name = EVTOPTAHF25815

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_heavy_troops
					value = 2
				}
			}
		}

		tiered_piety_reward_effect = yes

		capital_scope = {
			show_scope_change = no

			add_province_modifier = {
				name = kid_crusade_pledged_troops
				months = 40
				stacking = yes
			}
		}

		ai_chance = { factor = 10 }
	}

	option = { # Send reinforcements/ships
		name = EVTOPTBHF25815

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_forces
					value = 2
				}
			}
		}

		tiered_piety_reward_effect = yes

		transfer_scaled_wealth = {
			to = event_target:childrens_crusade_leader
			value = 1
			min = 150
			max = 350
		}

		ai_chance = { factor = 10 }
	}

	option = { # Send money
		name = EVTOPTCHF25815

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		transfer_scaled_wealth = {
			to = event_target:childrens_crusade_leader
			value = 1
			min = 50
			max = 100
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 5
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}
			}
		}

		ai_chance = { factor = 10 }
	}

	option = { # Do nothing
		name = EVTOPTDHF25815

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = {
		name = EVTOPTEHF25815

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { character = ROOT } }
			}
		}
	}
}

# Christian players informed that the Crusade has shipwrecked into Achaia
narrative_event = {
	id = HF.25816
	title = EVTTITLEHF25816
	desc = EVTDESCAHF25816
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_new = yes

	# Sponsor sends supplies to avoid starvation
	# Sponsor sends bureaucratic help
	# Sponsor uses local connections
	# Sponsor does nothing
	# Default

	option = { # Send supplies to avoid starvation
		name = EVTOPTAHF25816

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 3
				}
			}
		}

		scaled_wealth = {
			value = -1
			min = -250
			max = -500
		}

		tiered_piety_reward_effect = yes

		ai_chance = { factor = 10 }
	}

	option = { # Send diplomats to help them
		name = EVTOPTBHF25816

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			prestige = 250
		}

		prestige = -250

		ai_chance = { factor = 10 }
	}

	option = { # Use local connections
		name = EVTOPTCHF25816

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			prestige = 50

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 5
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}
			}
		}

		tiered_prestige_negative_effect = yes

		ai_chance = { factor = 10 }
	}

	option = { # Do nothing
		name = EVTOPTDHF25816

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = {
		name = EVTOPTEHF25816

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { character = ROOT } }
			}
		}
	}
}

# Christian players informed that the Crusade has crawled to Nikaea
narrative_event = {
	id = HF.25817
	title = EVTTITLEHF25817
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	desc = {
		text = EVTDESCAHF25817
		trigger = {
			NOT = {
				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCBHF25817
		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}
	}

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_new = yes

	# Sponsor offers military support in coming war
	# Sponsor offers economic support in coming war
	# Sponsor offers moral support in coming war
	# Sponsor does nothing
	# Default

	option = { # Sponsor offers military support in coming war
		name = EVTOPTAHF25817
		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 3
				}
			}
		}

		set_character_flag = flag_childrens_crusade_sponsor_joins_war
		tiered_piety_reward_effect = yes

		ai_chance = { factor = 10 }
	}

	option = { # Sponsor offers economic support in coming war

		name = EVTOPTBHF25817

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 15
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}

				wealth = 100
				prestige = 150
			}
		}

		add_character_modifier = {
			name = kid_crusade_economic_support
			months = 40
		}

		ai_chance = { factor = 10 }
	}

	option = { # Sponsor offers moral support in coming war
		name = EVTOPTCHF25817

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		event_target:childrens_crusade_leader = {
			show_scope_change = no

			prestige = 50
			piety = 100

			opinion = {
				name = opinion_grateful
				who = ROOT
				years = 5
			}

			hidden_effect = {
				change_variable = {
					which = children_crusade_morale
					value = 2
				}
			}
		}

		tiered_piety_negative_effect = yes

		ai_chance = { factor = 10 }
	}

	option = { # Do nothing
		name = EVTOPTDHF25817

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		ai_chance = { factor = 100 }
	}

	option = {
		name = EVTOPTEHF25817

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { character = ROOT } }
			}
		}
	}
}

# Christian players informed that the Crusade has reached Antioch and is ready to engage infidels
narrative_event = {
	id = HF.25818
	title = EVTTITLEHF25818
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader

	desc = {
		text = EVTDESCAHF25818
		trigger = {
			NOT = {
				event_target:childrens_crusade_leader = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCBHF25818
		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}
	}

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_new = yes

	option = { # Join war as promised
		name = EVTOPTAHF25818

		trigger = { has_character_flag = flag_childrens_crusade_sponsor_joins_war }
	}

	option = { # Join war
		name = EVTOPTBHF25818

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}

			NOT = { has_character_flag = flag_childrens_crusade_sponsor_joins_war }
		}

		tiered_piety_reward_effect = yes
		set_character_flag = flag_childrens_crusade_sponsor_joins_war
		join_attacker_wars = event_target:childrens_crusade_leader
		hidden_effect = { join_defender_wars = event_target:childrens_crusade_leader } # Just in case...
	}

	option = { # Do nothing
		name = EVTOPTCHF25818

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}

			NOT = { has_character_flag = flag_childrens_crusade_sponsor_joins_war }
		}
	}

	option = {
		name = EVTOPTDHF25818

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { character = ROOT } }
			}
		}
	}
}

# Christian players informed that the Crusade has failed to start for whatever reason and the children have scattered.
narrative_event = {
	id = HF.25819
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25819
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_religion
	portrait = event_target:childrens_crusade_leader
	sound = crusade_outcome_negative

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_new = yes

	option = {
		name = EVTOPTAHF25819

		trigger = {
			event_target:childrens_crusade_leader = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		tiered_prestige_negative_effect = yes
	}

	option = {
		name = EVTOPTBHF25819

		trigger = {
			event_target:childrens_crusade_leader = {
				NOT = { persistent_event_target:childrens_crusade_sponsor_per = { character = ROOT } }
			}
		}
	}
}

# Crusader Child: Preparing to fire the crusade...
narrative_event = {
	id = HF.25820

	is_triggered_only = yes # move_childrens_crusade_region_effect
	hide_window = yes

	immediate = {
		while = {
			limit = {
				check_variable = {
					which = children_crusade_forces
					value > 0 # Keep looping until the variable reaches 0
				}
			}

			change_variable = {
				which = children_crusade_forces
				value = -1
			}

			spawn_unit = {
				province = location
				home = location
				owner = THIS
				attrition = 0.5
				reinforces = no
				is_looter = no
				can_toggle_looting = no
				cannot_inherit = yes
				merge = yes
				disband_on_peace = yes
				earmark = childrens_crusade_infantry_earmark

				troops = {
					light_infantry = { 3000 3000 }
					archers = { 100 100 }
				}
			}
		}

		while = {
			limit = {
				check_variable = {
					which = children_crusade_heavy_troops
					value > 0 # Keep looping until the variable reaches 0
				}
			}

			change_variable = {
				which = children_crusade_heavy_troops
				value = -1
			}

			spawn_unit = {
				province = location
				home = location
				owner = THIS
				attrition = 0.5
				reinforces = no
				is_looter = no
				can_toggle_looting = no
				cannot_inherit = yes
				merge = yes

				troops = {
					heavy_infantry = { 500 500 }
					light_cavalry = { 150 150 }
				}
			}
		}

		# Translate morale variable into morale modifier
		if = {
			limit = {
				check_variable = {
					which = children_crusade_morale
					value < -15
				}
			}

			add_character_modifier = {
				name = children_crusade_morale_0
				days = 1000
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = children_crusade_morale
					value < -7
				}
			}

			add_character_modifier = {
				name = children_crusade_morale_1
				days = 1000
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = children_crusade_morale
					value < -3
				}
			}

			add_character_modifier = {
				name = children_crusade_morale_2
				days = 1000
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = children_crusade_morale
					value < 2
				}
			}

			add_character_modifier = {
				name = children_crusade_morale_3
				days = 1000
			}
		}
		else = {
			add_character_modifier = {
				name = children_crusade_morale_4
				days = 1000
			}
		}

		set_variable = { which = children_crusade_progress value = 0 }
		set_variable = { which = children_crusade_forces value = 0 }
		set_variable = { which = children_crusade_heavy_troops value = 0 }
		set_variable = { which = children_crusade_morale value = 0 }

		c_jerusalem = {
			kingdom = {
				save_event_target_as = target_kingdom
			}

			holder_scope = {
				top_liege = {
					event_target:childrens_crusade_leader = {
						unsafe_war = {
							target = PREV
							casus_belli = childrens_crusade
							thirdparty_title = event_target:target_kingdom
						}
					}
				}
			}
		}

		persistent_event_target:childrens_crusade_sponsor_per = {
			if = {
				limit = { has_character_flag = flag_childrens_crusade_sponsor_joins_war }

				join_attacker_wars = ROOT
				join_defender_wars = ROOT
			}
		}
	}
}

# War was invalidated
narrative_event = {
	id = HF.25823
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25823
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes # on_invalidation, childrens_crusade CB
	hide_new = yes

	option = {
		name = EVTOPTAHF25823

		if = {
			limit = {
				FROM = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}

			tiered_prestige_negative_effect = yes
		}
	}
}

# Infidels notified of crusade's start
narrative_event = {
	id = HF.25824
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25824
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war

	is_triggered_only = yes # on_add, childrens_crusade CB
	hide_new = yes

	ai = no

	option = {
		name = EVTOPTAHF25824
	}
}

# Crusade has failed (Christians)
narrative_event = {
	id = HF.25825
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25825
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war
	sound = crusade_outcome_negative

	is_triggered_only = yes # on_reverse_demand, childrens_crusade CB
	hide_new = yes

	option = {
		name = EVTOPTAHF25825

		if = {
			limit = {
				FROM = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}

			tiered_prestige_negative_effect = yes
		}
	}
}

# Crusade has failed (Infidels)
narrative_event = {
	id = HF.25826
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25826
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war
	sound = crusade_outcome_negative

	is_triggered_only = yes # on_reverse_demand, childrens_crusade CB
	hide_new = yes

	ai = no

	option = {
		name = EVTOPTAHF25826
	}
}

# Crusade has succeeded (Infidels)
narrative_event = {
	id = HF.25827
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25827
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war
	sound = crusade_outcome_positive

	is_triggered_only = yes # on_success_title, childrens_crusade CB
	hide_new = yes

	option = {
		name = EVTOPTAHF25827

		trigger = {
			independent = yes
			lower_real_tier_than = KING
			capital_scope = { region = world_middle_east_jerusalem }

			NOR = {
				is_vassal_or_below = FROM
				religion = FROM
				has_character_flag = ai_flag_refuse_conversion
				trait = zealous
			}
		}

		religion = FROM
		set_defacto_liege = FROM

		ai_chance = {
			factor = 10

			trigger = {
				NOT = { trait = cynical }
			}
		}
	}

	option = { # Newly vassalized infidels always convert
		name = EVTOPTAHF25827

		trigger = { vassal_of = FROM }

		religion = FROM
	}

	option = {
		name = EVTOPTBHF25827

		trigger = {
			NOT = { vassal_of = FROM }
		}

		ai_chance = { factor = 100 }
	}
}

# Crusade has succeeded (Christians)
narrative_event = {
	id = HF.25828
	title = EVTTITLEHF25800
	desc = EVTDESCAHF25828
	picture = GFX_evt_childrens_crusade
	border = GFX_event_narrative_frame_war
	sound = crusade_outcome_positive

	is_triggered_only = yes # on_success_title, childrens_crusade CB
	hide_new = yes

	# Sponsor switches to play child king
	# Do nothing

	option = { # Switch to Child
		name = EVTOPTAHF25828

		trigger = {
			dynasty = FROM
			has_character_flag = flag_childrens_crusade_sponsor_joins_war

			FROM = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}

		custom_tooltip = {
			text = player_character_TT_HF25828
			set_player_character = FROM
		}

		tiered_piety_reward_effect = yes

		ai_chance = { factor = 0 }
	}

	option = {
		name = EVTOPTBHF25828

		trigger = {
			FROM = {
				persistent_event_target:childrens_crusade_sponsor_per = {
					character = ROOT
				}
			}
		}
	}

	option = {
		name = EVTOPTCHF25828
		tooltip_info = zealous

		trigger = {
			trait = zealous

			NOT = {
				FROM = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}
		}
	}

	option = {
		name = EVTOPTDHF25828
		tooltip_info = cynical

		trigger = {
			trait = cynical

			NOT = {
				FROM = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}
		}
	}

	option = {
		name = EVTOPTEHF25828

		trigger = {
			NOR = {
				trait = zealous
				trait = cynical

				FROM = {
					persistent_event_target:childrens_crusade_sponsor_per = {
						character = ROOT
					}
				}
			}
		}
	}
}